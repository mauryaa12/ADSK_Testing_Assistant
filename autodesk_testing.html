<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Autodesk Testing Assistant | TP Dashboard</title>
    <link rel="stylesheet" href="css/style.css">

    <style>
        .container { 
            max-width: 900px; 
            margin: 20px auto; 
            background: #fff; 
            padding: 20px; 
            border-radius: 10px; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); 
        }
        .container h2 { color: #0078d4; margin-bottom:10px;}
        .container label { display: block; margin-top: 15px; font-weight: bold; }
        .container input,
        .container select { 
            width: 100%; 
            padding: 8px; 
            margin-top: 5px; 
            border-radius: 6px; 
            border: 1px solid #ccc; 
        }
        .container button { 
            padding: 8px 14px; 
            border: none; 
            background: #0078d4; 
            color: white; 
            font-weight: bold; 
            border-radius: 6px; 
            margin-top: 10px; 
            cursor: pointer; 
        }
        .container button.secondary { 
            background: #e5f0fa; 
            color: #0078d4; 
            border: 1px solid #0078d4; 
        }
        .container ul { margin-top: 10px; padding-left:20px; }
        .container a { 
            display: block; 
            margin: 5px 0; 
            color: #0b5394; 
            text-decoration: none; 
            word-break: break-all; 
        }
        #yearContainer, 
        #manualContainer { 
            display: none; 
        }
    </style>
</head>

<body>

<!-- ================= NAVBAR ================= -->
<nav class="navbar">
    <div class="nav-title">TP Dashboard</div>
    <div class="nav-right">
        <a href="login.html" class="login-btn">Login</a>
    </div>
</nav>

<!-- ================= MAIN LAYOUT ================= -->
<div class="layout">

    <!-- ========== SIDEBAR ========== -->
    <aside class="sidebar">
        <a href="index.html">üè† Home</a>
        <a href="autodesk_testing.html" class="active">Autodesk Testing Assistant</a>
        <a href="product_details.html">üìò Product Details</a>
        <a href="product_management.html">üõ† Product Management</a>
        <a href="coming_soon.html">‚öô Coming Soon</a>
    </aside>

    <!-- ========== CONTENT ========== -->
    <main class="main-content">

        <div class="container">
            <h2>Autodesk ‚Äî Multi-Language Link Opener</h2>
            <p>Select a product or enter a manual staging/production link. The tool automatically detects single vs multi-branch release.</p>

            <label>Product</label>
            <select id="productSelect">
                <option value="">-- Select Product or Other --</option>
            </select>

            <div id="yearContainer">
                <label>Release Year</label>
                <select id="yearSelect"></select>
            </div>

            <div id="manualContainer">
                <label>Or Enter Manual Link / Product Name</label>
                <input id="manualInput" placeholder="https://help-staging.autodesk.com/view/NINCAD/2026/ENU/?guid=... OR https://help.autodesk.com/... OR NINCAD">
            </div>

            <label>GUID</label>
            <input id="guidInput" placeholder="Enter GUID (e.g. Best_Practices_16)">

            <label>Languages (comma separated)</label>
            <input id="langsInput" placeholder="ENU,DEU,FRA,CHS,ITA,JPN">

            <!-- Buttons row -->
            <button id="buildStagingBtn">Build Staging Links</button>
            <button id="buildProdBtn" class="secondary">Build Prod Links</button>
            <button id="openAllBtn" class="secondary">Open All</button>

            <p id="status" style="color: green; font-weight:600;"></p>
            <ul id="linksList"></ul>
        </div>

    </main>

</div>

<!-- ================= SCRIPT ================= -->
<script>

let productsData = [];

const productSelect   = document.getElementById('productSelect');
const yearSelect      = document.getElementById('yearSelect');
const yearContainer   = document.getElementById('yearContainer');
const manualContainer = document.getElementById('manualContainer');
const manualInput     = document.getElementById('manualInput');
const guidInput       = document.getElementById('guidInput');
const langsInput      = document.getElementById('langsInput');
const buildStagingBtn = document.getElementById('buildStagingBtn');
const buildProdBtn    = document.getElementById('buildProdBtn');
const openAllBtn      = document.getElementById('openAllBtn');
const linksList       = document.getElementById('linksList');
const status          = document.getElementById('status');


// ================= LOAD PRODUCTS =================
fetch('./products.json')
.then(response => response.json())
.then(data => {
    productsData = data;
    populateProducts();
    populateYears();
})
.catch(err => {
    console.error(err);
    alert('‚ùå Could not load products.json');
});


// ================= POPULATE PRODUCTS =================
function populateProducts() {

    productsData.forEach(product => {
        const option = document.createElement('option');

        option.value = product.code;
        option.textContent = `${product.code} ‚Äî ${product.name}`;

        // Save flags in data attributes
        option.dataset.usesYearBranch = String(product.usesYearBranch === true);

        if (Array.isArray(product.languages)) {
            option.dataset.languages = product.languages.join(',');
        }

        productSelect.appendChild(option);
    });

    const otherOption = document.createElement('option');
    otherOption.value = 'OTHER';
    otherOption.textContent = 'Other Product (Manual Entry)';
    productSelect.appendChild(otherOption);
}


// ================= POPULATE YEARS =================
function populateYears() {
    for (let year = 2055; year >= 1990; year--) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;

        if (year === 2026) option.selected = true;
        yearSelect.appendChild(option);
    }
}


// ================= PRODUCT CHANGE =================
productSelect.addEventListener('change', function () {

    const selected = productSelect.selectedOptions[0];
    if (!selected) return;

    const usesYear = selected.dataset.usesYearBranch === 'true';
    const isOther  = selected.value === 'OTHER';

    // Show / hide
    yearContainer.style.display   = usesYear ? 'block' : 'none';
    manualContainer.style.display = isOther  ? 'block' : 'none';

    // ‚úÖ AUTO FILL LANGUAGE
    if (selected.dataset.languages && !isOther) {
        langsInput.value = selected.dataset.languages;
    } 
    else if (isOther) {
        langsInput.value = '';
    } 
    else {
        langsInput.value = '';
    }

});


// ================= ENV-SPECIFIC BUILD HANDLERS =================
buildStagingBtn.addEventListener('click', () => {
    buildLinks('staging');   // https://help-staging.autodesk.com
});

buildProdBtn.addEventListener('click', () => {
    buildLinks('prod');      // https://help.autodesk.com
});


// ================= MAIN BUILD FUNCTION =================
function buildLinks(env) {

    linksList.innerHTML = '';
    status.textContent  = '';

    const productCode = productSelect.value;
    const manual      = manualInput.value.trim();
    const guid        = guidInput.value.trim();
    const langs       = langsInput.value.trim();

    if (!guid) {
        alert('‚ùó Please enter a GUID');
        return;
    }

    const languageList = langs.split(',')
                              .map(l => l.trim().toUpperCase())
                              .filter(Boolean);

    let baseUrl = '';
    let year    = null;

    // Product selected from dropdown
    if (productCode && productCode !== 'OTHER') {

        const selected = productSelect.selectedOptions[0];
        const usesYear = selected.dataset.usesYearBranch === 'true';

        baseUrl = getBaseUrl(productCode, env);

        if (usesYear) {
            year = yearSelect.value || '2026';
        }

    } 
    // Manual input (URL or product code)
    else if (manual) {

        const info = analyzeManual(manual);

        if (!info) {
            alert('‚ùå Invalid manual input');
            return;
        }

        baseUrl = getBaseUrl(info.product, env);
        year    = info.year;

    } 
    else {
        alert('‚ùó Select a product or enter a manual link / product code');
        return;
    }

    const urls = buildUrls(baseUrl, languageList, guid, year);

    urls.forEach(url => {
        const li = document.createElement('li');
        const a  = document.createElement('a');
        a.href        = url;
        a.target      = '_blank';
        a.textContent = url;
        li.appendChild(a);
        linksList.appendChild(li);
    });

    const envLabel = env === 'prod' ? 'production' : 'staging';
    status.textContent = `‚úÖ ${urls.length} ${envLabel} links generated successfully`;
}


// ================= BASE URL BY ENV =================
function getBaseUrl(productCode, env) {
    const host = (env === 'prod')
        ? 'https://help.autodesk.com'
        : 'https://help-staging.autodesk.com';
    return `${host}/view/${productCode}`;
}


// ================= URL BUILDER =================
function buildUrls(baseUrl, langs, guid, year) {

    baseUrl = baseUrl.replace(/\/+$/, '');
    const urls = [];

    langs.forEach(lang => {
        if (year) {
            urls.push(`${baseUrl}/${year}/${lang}/?guid=${encodeURIComponent(guid)}`);
        } else {
            urls.push(`${baseUrl}/${lang}/?guid=${encodeURIComponent(guid)}`);
        }
    });

    return urls;
}


// ================= MANUAL LINK ANALYZER =================
// Accepts:
//   - full staging URL, e.g. https://help-staging.autodesk.com/view/CONNECT/ENU/?guid=Best_Practices_16
//   - full prod URL,    e.g. https://help.autodesk.com/view/CONNECT/ENU/?guid=Best_Practices_16
//   - or plain product code, e.g. CONNECT
function analyzeManual(input) {

    try {
        const u = new URL(input);
        const parts = u.pathname.split('/').filter(Boolean);

        const viewIndex = parts.indexOf('view');
        if (viewIndex === -1) return null;

        const afterView = parts.slice(viewIndex + 1);

        const product = afterView[0];                      // CONNECT, NINCAD, etc.
        const year    = /^\d{4}$/.test(afterView[1]) 
                        ? afterView[1] 
                        : null;

        return { product, year };
    } 
    catch {
        // Not a URL ‚Üí maybe just product code like "CONNECT"
        if (/^[A-Z0-9]+$/i.test(input)) {
            return { 
                product: input,
                year: null 
            };
        }
        return null;
    }

}


// ================= OPEN ALL =================
openAllBtn.addEventListener('click', () => {

    const links = document.querySelectorAll('#linksList a');

    if (!links.length) {
        alert('No links to open');
        return;
    }

    links.forEach(a => a.click());
});

</script>

</body>
</html>
